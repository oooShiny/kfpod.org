<!DOCTYPE html>
<html>

<head>
    <title>Knowledge Fight Podcast</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/x-icon" href="/images/kfpod.png">
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.12.14/dist/full.min.css" rel="stylesheet" type="text/css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        main {
            background-color: #becbd3;
            background-image: url('images/kf-bg.png');
            background-size: cover;
            background-position: bottom;
            background-blend-mode: soft-light;
        }

        body,
        footer {
            background-color: #bdcbd3;
        }

        @media (prefers-color-scheme: dark) {

            html,
            body,
            main,
            footer {
                background-color: #212121 !important;
            }
        }
    </style>
</head>

<body>
    <div id="body-content" class="flex flex-col h-screen justify-between">
        <header class="py-10">
            <h1 class="text-5xl lg:text-7xl font-bold text-center uppercase tracking-widest">Knowledge Fight</h1>
        </header>
        <!-- <nav>
            <ul class="flex gap-8 mx-auto w-fit">
                <li>Home</li>
                <li>About</li>
                <li>Search</li>
            </ul>
        </nav> -->
        <main class="mb-auto px-10">
            <p class="text-lg py-3">
                Alex Jones is a fraud. The <a href="https://knowledgefight.com/">Knowledge Fight podcast</a> has been
                fact checking Jones for years, and have accumulated hundreds of episodeds debunking all of the claims
                made on InfoWars. Dan and Jordan also outline just how Jones pulls off his grift by detailing all of the
                rhetorical tricks the large-necked host uses to con his listeners.
            </p>

            <div class="container mx-auto py-10 grid gap-10">
                <form action="" method="get" id="searchForm">
                    <input type="text" name="search" class="input input-bordered w-full max-w-xs searchBox" id="search"
                        placeholder="Search...">
                </form>
                <div id="search-results" class="grid gap-4"></div>
            </div>
            <script>
                /* paste this line in verbatim */
                window.formbutton = window.formbutton || function () { (formbutton.q = formbutton.q || []).push(arguments) };
                /* customize formbutton below*/
                formbutton("create", {
                    action: "https://formspree.io/f/xeoopgpv",
                    title: "Suggest an Episode",
                    fields: [
                        {
                            type: "email",
                            label: "Email:",
                            name: "email",
                            required: true,
                            placeholder: "your@email.com"
                        },
                        {
                            type: "textarea",
                            label: "Message:",
                            name: "message",
                            placeholder: "Got a suggestion of a good KF episode? Let us know!",
                        },
                        { type: "submit" }
                    ],
                });

                // Search functionality
                const searchForm = document.getElementById('searchForm');
                const searchBox = document.getElementById('search');
                const searchResults = document.getElementById('search-results');

                searchForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const searchTerm = searchBox.value.trim();
                    console.log('Search term:', searchTerm);

                    if (searchTerm) {
                        try {
                            const apiUrl = `https://fight.fudgie.org/search/api/search/?s=kf&keywords=${encodeURIComponent(searchTerm)}&exact=on&invert=off&order=episode&limit=25`;
                            console.log('Requesting URL:', apiUrl);
                            console.log('Full proxy URL:', `https://kfpodorg.arbrown83.workers.dev/?apiUrl=${encodeURIComponent(apiUrl)}`);

                            const response = await axios.get(`https://kfpodorg.arbrown83.workers.dev/?apiUrl=${encodeURIComponent(apiUrl)}`, {
                                headers: {
                                    'Accept': 'application/json'
                                }
                            });

                            console.log('Raw response:', response);
                            console.log('Response data type:', typeof response.data);
                            console.log('Response data:', response.data);

                            // Clear previous results
                            searchResults.innerHTML = '';

                            // Check if we have results
                            if (response.data && response.data.results && Array.isArray(response.data.results)) {
                                console.log('Number of results:', response.data.results.length);

                                // Group results by episode date
                                const episodeGroups = {};
                                response.data.results.forEach(result => {
                                    if (!episodeGroups[result.date]) {
                                        episodeGroups[result.date] = [];
                                    }
                                    episodeGroups[result.date].push(result);
                                });

                                // Display results grouped by episode
                                Object.keys(episodeGroups).sort().forEach(date => {
                                    const episodeDiv = document.createElement('div');
                                    episodeDiv.className = 'mb-8';

                                    // Add episode date header
                                    const dateHeader = document.createElement('h2');
                                    dateHeader.className = 'text-xl font-bold mb-4';
                                    dateHeader.textContent = new Date(date).toLocaleDateString('en-US', {
                                        weekday: 'long',
                                        year: 'numeric',
                                        month: 'long',
                                        day: 'numeric'
                                    });
                                    episodeDiv.appendChild(dateHeader);

                                    // Add each mention from the episode
                                    episodeGroups[date].forEach(result => {
                                        const resultDiv = document.createElement('div');
                                        resultDiv.className = 'bg-accent-content/50 border border-base-300 dark:text-gray-200 mb-4 p-4 rounded-lg shadow text-base-100';
                                        resultDiv.innerHTML = `
                                            <div class="text-sm text-gray-00 mb-2">${result.timestamp}</div>
                                            <div class="quote">
                                                <p class="text-gray-400">${result.prev_line}</p>
                                                <p class="font-medium my-2">${result.line}</p>
                                                <p class="text-gray-400">${result.next_line}</p>
                                            </div>
                                            <a href="${result.url}" class="btn btn-outline btn-primary btn-sm" target="_blank">
                                                View in episode â†’
                                            </a>
                                        `;
                                        episodeDiv.appendChild(resultDiv);
                                    });

                                    searchResults.appendChild(episodeDiv);
                                });

                                if (response.data.results.length === 0) {
                                    searchResults.innerHTML = '<p class="text-center">No results found</p>';
                                }
                            } else {
                                searchResults.innerHTML = '<p class="text-center">No results found</p>';
                            }
                        } catch (error) {
                            console.error('Full error:', error);
                            searchResults.innerHTML = '<p class="text-center text-red-500">Error fetching results. Please try again.</p>';
                        }
                    }
                });
            </script>
    </div>

    <img class="mx-auto h-40" src="images/aj-footer.png" alt="AJ">
    </main>
    <footer>

    </footer>
    </div>
</body>
<script src="https://formspree.io/js/formbutton-v1.min.js" defer></script>
<script>
    /* paste this line in verbatim */
    window.formbutton = window.formbutton || function () { (formbutton.q = formbutton.q || []).push(arguments) };
    /* customize formbutton below*/
    formbutton("create", {
        action: "https://formspree.io/f/xeoopgpv",
        title: "Suggest an Episode",
        fields: [
            {
                type: "email",
                label: "Email:",
                name: "email",
                required: true,
                placeholder: "your@email.com"
            },
            {
                type: "textarea",
                label: "Message:",
                name: "message",
                placeholder: "Got a suggestion of a good KF episode? Let us know!",
            },
            { type: "submit" }
        ],
    });
</script>

</html>